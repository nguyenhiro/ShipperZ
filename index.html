<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mario Đơn Giản (Tối ưu Mobile Ngang)</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #87ceeb;
            background-image: url('body.jpg'); /* Đường dẫn đến ảnh nền bạn muốn */
            background-size: cover; 
            background-repeat: no-repeat;
            background-position: center center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation; /* Ngăn chặn double tap zoom */
        }

        #game-container {
            /* Tối ưu hóa: Sử dụng vmin và aspect-ratio để co giãn và giữ tỷ lệ */
            width: 90vmin; 
            height: 45vmin; /* Tỉ lệ 2:1 */
            aspect-ratio: 2 / 1; 
            max-width: 100vw;
            max-height: 100vh;
            
            border: 5px solid #333;
            background-color: #aaddff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #game-world {
            position: absolute;
            top: 0;
            left: 0;
            width: 2500px; /* Kích thước thế giới cố định */
            height: 100%;
            transition: transform 0.1s linear;
            background-image: url('viahe1.jpg');
            background-size: 500px 100%;
            background-repeat: repeat-x;
            background-position: center bottom;
            image-rendering: pixelated; /* Sử dụng pixelated rendering cho game cổ điển */
            background-color: #2c1810;
        }
        
        #game-world::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(0deg, 
                rgba(0,0,0,0.2) 0%,
                rgba(0,0,0,0.1) 20%,
                rgba(0,0,0,0) 50%,
                rgba(0,0,0,0.1) 80%,
                rgba(0,0,0,0.2) 100%
            );
            pointer-events: none;
            z-index: 3;
        }

        #player {
            width: 130px;
            height: 130px;
            background-image: url('nhanvat.png');
            background-size: contain;
            background-position: center bottom;
            background-repeat: no-repeat;
            position: absolute;
            image-rendering: pixelated;
            z-index: 10;
        }

        #player.flipped {
            transform: scaleX(-1);
        }

        .platform, .obstacle, .hazard, .moving-obstacle, .passthrough-platform {
            position: absolute;
            z-index: 5;
            /* ... (Giữ nguyên styles cho elements trong game-world) ... */
        }
        
        .platform {
            height: 50px;
            background: none;
            background-color: transparent;
            border: none;
            pointer-events: auto;
            background-repeat: no-repeat;
            background-position: center bottom;
            background-size: contain;
        }

        .passthrough-platform {
            height: 40px;
            z-index: 4;
            background-image: url('ongnuoc.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            opacity: 0.9;
            pointer-events: none;
        }

        /* Thêm hiệu ứng cảnh báo cho hố sâu */
        .passthrough-platform::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(to bottom,
                rgba(255, 0, 0, 0.2),
                rgba(255, 0, 0, 0)
            );
            animation: warning 1s infinite;
        }

        @keyframes warning {
            0% { opacity: 0.3; }
            50% { opacity: 0.7; }
            100% { opacity: 0.3; }
        }

        .obstacle, .hazard, .moving-obstacle {
            background-color: #8B4513;
            background-image: url('khucgo.jpg');
            background-size: cover;
            background-repeat: repeat-x;
            border: 2px solid #555;
            z-index: 6;
        }
        .hazard {
            background-color: transparent;
            border: none;
            background-repeat: no-repeat;
            background-position: center bottom;
            z-index: 6;
        }
        .moving-obstacle {
            background-color: transparent;
            border: none;
            background-repeat: no-repeat;
            background-position: center bottom;
            z-index: 6;
        }
        
        #finish-line {
            width: 400px;
            height: 400px;
            background-color: transparent;
            position: absolute;
            background-image: url('hopbian.png'); 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: none;
            z-index: 7;
        }

        /* Vị trí mặc định trên PC (góc trên bên trái) */
        #game-info {
            position: absolute;
            top: 10px;
            left: 10px;
            font-family: 'Roboto', sans-serif;
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #time-display, #level-display {
            font-weight: bold;
            font-size: 1.2em;
            color: white;
            text-shadow: 2px 2px 3px black;
        }

        #reset-character {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        #reset-character:hover {
            background-color: #45a049;
        }
        
        /* Controls wrapper để dễ dàng ẩn/hiện trên PC */
        #controls-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Cho phép các sự kiện chạm xuyên qua nếu không chạm vào nút */
        }
        
        /* Mobile jump button (right side) */
        #jump-button {
            position: absolute;
            right: 14px;
            bottom: 60px;
            width: 92px;
            height: 92px;
            border-radius: 50%;
            background: rgba(0,0,0,0.35);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-family: 'Roboto', sans-serif;
            z-index: 30;
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            pointer-events: auto; /* Quan trọng: cho phép chạm vào nút */
        }

        #jump-button:active {
            background: rgba(255,255,255,0.12);
            transform: translateY(1px);
        }

        /* Left-side joystick container */
        #joystick {
            position: absolute;
            left: 14px;
            bottom: 40px;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: rgba(0,0,0,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 29;
            touch-action: none;
            pointer-events: auto; /* Quan trọng: cho phép chạm vào joystick */
        }

        #joystick-knob {
            width: 62px;
            height: 62px;
            border-radius: 50%;
            background: rgba(255,255,255,0.18);
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            transition: transform 0.06s linear;
            pointer-events: none;
        }

        /* Controls description placed below Reset Nhân Vật */
        #controls-desc {
            font-size: 0.9em;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            max-width: 260px;
            line-height: 1.2;
        }

        /* ----------------------------------------------- */
        /* --- TỐI ƯU HÓA MOBILE (MÀN HÌNH NGANG) --- */
        /* ----------------------------------------------- */
        @media screen and (orientation: landscape) and (max-width: 1000px) {
            
            /* Đảm bảo game chiếm tối đa không gian */
            body {
                min-height: 100vh;
                align-items: center;
                justify-content: center;
            }

            #game-container {
                /* Vmin dựa trên cạnh nhỏ nhất (chiều cao) nên sẽ đảm bảo game vừa màn hình */
                width: calc(100vw - 100px); /* Lấy gần hết chiều rộng */
                height: 90vh;
                max-height: 45vmin; /* Giới hạn chiều cao */
                aspect-ratio: 2 / 1;
            }

            /* Di chuyển thông tin game ra khỏi container chính để không bị che khuất */
            #game-info {
                position: fixed; 
                top: 2vmin;
                left: auto; /* Loại bỏ left: 10px cũ */
                right: 2vmin; /* Căn góc trên bên phải */
                text-align: right;
                z-index: 101;
                font-size: 1.1em;
            }
            
            /* Phóng to và căn chỉnh nút NHẢY */
            #jump-button {
                right: 3vmin; 
                bottom: 10vmin; 
                width: 14vmin; 
                height: 14vmin;
                font-size: 3vmin;
            }

            /* Phóng to và căn chỉnh Joystick */
            #joystick {
                left: 3vmin; 
                bottom: 6vmin; 
                width: 22vmin; 
                height: 22vmin;
            }

            #joystick-knob {
                width: 10vmin; 
                height: 10vmin;
            }
            
            /* Ẩn mô tả điều khiển trên di động (sẽ được xử lý lại trong JS) */
            #controls-desc {
                display: none; 
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-world">
            <div id="player"></div>
            <div id="finish-line"></div>
        </div>
        
        <div id="controls-wrapper">
            <div id="joystick" aria-hidden="false">
                <div id="joystick-knob"></div>
            </div>
            <div id="jump-button" role="button" aria-label="Nhảy">NHẢY</div>
        </div>
    </div>

    <div id="game-info">
        <div id="time-display">Thời gian: 00:00</div>
        <div id="level-display">Màn: 1</div>
        <button id="reset-character" onclick="resetCharacter()">Reset Nhân Vật</button>
        <div id="controls-desc">
            Hướng dẫn: A / D hoặc ← / → để di chuyển. Space hoặc chạm nút "NHẢY" để nhảy.
        </div>
    </div>
    <div id="game-message">
        <p>Bạn đã chiến thắng!</p>
        <button id="reset-button">Chơi Lại</button>
    </div>

    <script>
        const player = document.getElementById('player');
        const gameContainer = document.getElementById('game-container');
        const gameWorld = document.getElementById('game-world');
        const finishLine = document.getElementById('finish-line');
        const gameMessage = document.getElementById('game-message');
        const timeDisplay = document.getElementById('time-display');
        const levelDisplay = document.getElementById('level-display');
        const jumpButton = document.getElementById('jump-button');
        const joystick = document.getElementById('joystick');
        const joystickKnob = document.getElementById('joystick-knob');
        const controlsWrapper = document.getElementById('controls-wrapper');
        const controlsDesc = document.getElementById('controls-desc');
        
        // Theo dõi loại nhân vật và level game
        let currentCharacter = 'nhanvat.png';
        let gameLevel = 1;
        const MAX_LEVEL = 5;
        const TIME_LIMIT = 60000; // 60 seconds in milliseconds
        
        const characterProgression = {
            1: 'nhanvat.png', 2: 'chuquan.png', 3: 'cogiao.png', 4: 'bodoi.png', 5: 'bacsi.png'
        };

        // Biến vật lý và trạng thái
        let playerX = 50;
        let playerY = 0;
        const playerBaseWidth = 60;
        const playerBaseHeight = 60;
        let playerActualWidth = playerBaseWidth;
        let playerActualHeight = playerBaseHeight;
        const hitboxXOffset = 10;
        const hitboxYOffset = 5;
        const deathFallThreshold = -100; 
        let isJumping = false;
        let isMovingLeft = false;
        let isMovingRight = false;
        let isGameOver = false;
        let isOnPlatform = false; 

        const moveAcceleration = 1.2;
        const friction = 0.8;
        const maxSpeed = 6;
        const jumpStrength = 14;
        const gravity = 0.6;
        let xVelocity = 0;
        let yVelocity = 0;

        let cameraX = 0;
        let facingRight = true;

        let lastFrameTime = 0;
        const targetFPS = 60;
        const frameInterval = 1000 / targetFPS;

        let gameElements = [];
        let movingObstacles = [];
        
        let startTime = 0;
        let winHistory = JSON.parse(localStorage.getItem('gameWinHistory')) || [];

        // --- HÀM TẠO LEVEL VÀ CẬP NHẬT GAME ---
        function createLevel(levelData) {
            gameElements.forEach(el => el.remove());
            gameElements = [];
            movingObstacles = [];

            finishLine.style.left = levelData.finishLine.left + 'px';
            finishLine.style.bottom = levelData.finishLine.bottom + 'px';
            finishLine.style.width = levelData.finishLine.width + 'px';
            finishLine.style.height = levelData.finishLine.height + 'px';
            
            levelData.elements.forEach(data => {
                const el = document.createElement('div');
                el.classList.add(data.type);
                el.style.left = data.left + 'px';
                el.style.bottom = data.bottom + 'px';
                el.style.width = data.width + 'px';
                el.style.height = data.height + 'px';
                gameWorld.appendChild(el);
                gameElements.push(el);

                // ... (Logic apply image và moving obstacle như code gốc) ...
                 if (data.image) {
                     if (data.type === 'hazard' && /phancute/i.test(data.image)) {
                         const img = document.createElement('img');
                         img.src = data.image;
                         img.alt = '';
                         img.style.position = 'absolute';
                         img.style.left = '50%';
                         img.style.transform = 'translateX(-50%)';
                         img.style.bottom = '0';
                         img.style.width = '80%';
                         img.style.height = 'auto';
                         img.style.pointerEvents = 'none';
                         img.style.userSelect = 'none';
                         el.appendChild(img);
                         el.style.backgroundImage = '';
                         el.style.backgroundSize = 'contain';
                     } else {
                         el.style.backgroundImage = `url('${data.image}')`;
                         el.style.backgroundRepeat = 'no-repeat';
                         el.style.backgroundPosition = 'center bottom';
                         if (data.type === 'moving-obstacle' || data.type === 'hazard') {
                             el.style.backgroundSize = 'contain';
                         } else {
                             if (data.type === 'platform') {
                                 el.style.backgroundSize = 'contain';
                             } else {
                                 el.style.backgroundSize = `${data.width}px ${data.height}px`;
                             }
                         }
                     }
                     if (data.type === 'hazard' || data.type === 'platform') {
                         el.style.border = 'none';
                         el.style.backgroundColor = 'transparent';
                     }
                 }

                 if (data.type === 'moving-obstacle') {
                     movingObstacles.push({
                         element: el,
                         initialLeft: data.left,
                         range: data.range,
                         speed: data.speed,
                         direction: 1,
                         pushForce: data.pushForce || 8
                     });
                 }
            });
        }
        
        // Dữ liệu Level 1 (Giữ nguyên)
        const level1Data = {
            worldWidth: 2500,
            finishLine: { left: 2450, bottom: 50, width: 50, height: 150 },
            elements: [
                { type: 'platform', left: 0, width: 600, height: 50, bottom: 0, image: 'thungrac.png' }, 
                { type: 'platform', left: 700, width: 400, height: 50, bottom: 0, image: 'thungrac.png' },
                { type: 'platform', left: 1200, width: 400, height: 50, bottom: 0, image: 'thungrac.png' },
                { type: 'platform', left: 1700, width: 300, height: 50, bottom: 0, image: 'thungrac.png' },
                { type: 'platform', left: 2100, width: 400, height: 50, bottom: 0, image: 'thungrac.png' },

                { type: 'passthrough-platform', left: 600, width: 100, height: 40, bottom: 0, image: 'ongnuoc.png' },
                { type: 'passthrough-platform', left: 1100, width: 100, height: 40, bottom: 0, image: 'ongnuoc.png' },
                { type: 'passthrough-platform', left: 1600, width: 100, height: 40, bottom: 0, image: 'ongnuoc.png' },
                { type: 'passthrough-platform', left: 2000, width: 100, height: 40, bottom: 0, image: 'ongnuoc.png' },

                { type: 'hazard', left: 350, width: 80, height: 80, bottom: 50, image: 'cuncute.png' },
                { type: 'hazard', left: 900, width: 50, height: 50, bottom: 50, image: 'phancute.png' },
                { type: 'hazard', left: 1500, width: 50, height: 50, bottom: 50, image: 'phancute.png' },
                { type: 'hazard', left: 2300, width: 50, height: 50, bottom: 50, image: 'phancute.png' },

                { type: 'moving-obstacle', left: 500, width: 60, height: 60, bottom: 60, range: 120, speed: 1.2, pushForce: 8, image: 'bongbong.png' },
                { type: 'moving-obstacle', left: 1300, width: 60, height: 60, bottom: 60, range: 160, speed: 1.0, pushForce: 10, image: 'bongbong.png' },
                { type: 'moving-obstacle', left: 2100, width: 60, height: 60, bottom: 60, range: 120, speed: 1.5, pushForce: 9, image: 'bongbong.png' }
            ]
        };

        function updateTimer() { /* ... (Giữ nguyên logic updateTimer) ... */
             if (isGameOver) return;
             const currentTime = performance.now();
             const timeElapsed = currentTime - startTime;
             const timeRemaining = TIME_LIMIT - timeElapsed;
             
             if (timeRemaining <= 0) {
                 endGame('Hết thời gian! Bạn đã thua.');
                 return;
             }

             const seconds = Math.ceil(timeRemaining / 1000); 
             timeDisplay.textContent = `Thời gian: ${seconds}s`;

             if (seconds <= 10) {
                 timeDisplay.style.color = seconds % 2 === 0 ? 'red' : 'white';
             }
        }
        function resetTimer() { /* ... (Giữ nguyên logic resetTimer) ... */
             startTime = performance.now();
             timeDisplay.style.color = 'white';
        }
        function updatePlayerPosition() { /* ... (Giữ nguyên logic updatePlayerPosition) ... */
             player.style.left = playerX + 'px';
             player.style.bottom = playerY + 'px';

             if (xVelocity < 0 && facingRight) {
                 player.classList.add('flipped');
                 facingRight = false;
             } else if (xVelocity > 0 && !facingRight) {
                 player.classList.remove('flipped');
                 facingRight = true;
             }
        }

        function jump() {
            if (!isJumping && isOnPlatform) { 
                isJumping = true;
                yVelocity = jumpStrength;
                isOnPlatform = false; 
            }
        }

        function getElementRect(element) { /* ... (Giữ nguyên logic getElementRect) ... */
             const left = parseInt(element.style.left);
             const bottom = parseInt(element.style.bottom);
             const width = element.offsetWidth;
             const height = element.offsetHeight;
             const right = left + width;
             const top = bottom + height;
             return { left, right, bottom, top, width, height };
        }

        function checkCollisionsX() { /* ... (Giữ nguyên logic checkCollisionsX) ... */
             if (isGameOver) return;
             const playerHitbox = {
                 left: playerX + hitboxXOffset,
                 right: playerX + playerActualWidth - hitboxXOffset,
                 bottom: playerY + hitboxYOffset,
                 top: playerY + playerActualHeight
             };

             gameElements.forEach(element => {
                 if (isGameOver) return;
                 const elementRect = getElementRect(element);

                 const horizontalOverlap = playerHitbox.left < elementRect.right && playerHitbox.right > elementRect.left;
                 const verticalOverlap = playerHitbox.top > elementRect.bottom && playerHitbox.bottom < elementRect.top;

                 if (horizontalOverlap && verticalOverlap) {
                     if (element.classList.contains('hazard')) {
                         endGame('Bạn đã chạm chướng ngại vật nguy hiểm!');
                         if (isGameOver) return;
                     }

                     if (element.classList.contains('moving-obstacle')) {
                         const movingObs = movingObstacles.find(obs => obs.element === element);
                         if (movingObs) {
                             const playerCenter = playerX + playerActualWidth / 2;
                             const obstacleCenter = elementRect.left + elementRect.width / 2;
                             const pushForce = movingObs.speed * (movingObs.pushForce || 8);

                             if (playerCenter < obstacleCenter) {
                                 xVelocity = -pushForce;
                                 playerX = elementRect.left - playerActualWidth - 5;
                             } else {
                                 xVelocity = pushForce;
                                 playerX = elementRect.right + 5;
                             }
                             
                             if (yVelocity <= 0) {
                                 yVelocity = 5;
                             }
                         }
                     } else if (element.classList.contains('platform') || element.classList.contains('obstacle')) {
                         if (xVelocity > 0) {
                             playerX = elementRect.left - (playerActualWidth - hitboxXOffset);
                             xVelocity = 0;
                         }
                         else if (xVelocity < 0) {
                             playerX = elementRect.right - hitboxXOffset;
                             xVelocity = 0;
                         }
                     }
                 }
             });
        }

        function checkCollisionsY(previousPlayerY) { /* ... (Giữ nguyên logic checkCollisionsY) ... */
             if (isGameOver) return;
             let playerCurrentlyOnPlatform = false;
             let newPlayerY = playerY;

             // Kiểm tra va chạm từ dưới lên (đụng trần)
             if (yVelocity > 0) {
                 const playerTopY = previousPlayerY + playerActualHeight;
                 const playerFutureTopY = playerY + playerActualHeight;

                 gameElements.forEach(element => {
                     if (element.classList.contains('platform') || element.classList.contains('obstacle') || element.classList.contains('moving-obstacle')) {
                         const elementRect = getElementRect(element);
                         
                         const horizontalOverlap = (
                             playerX + hitboxXOffset < elementRect.right &&
                             playerX + playerActualWidth - hitboxXOffset > elementRect.left
                         );

                         if (horizontalOverlap && 
                             playerFutureTopY >= elementRect.bottom && 
                             playerTopY <= elementRect.bottom) {
                             
                             if (element.classList.contains('hazard')) {
                                 endGame('Bạn đã chạm chướng ngại vật nguy hiểm!');
                                 return;
                             }
                             
                             newPlayerY = elementRect.bottom - playerActualHeight;
                             yVelocity = 0;
                         }
                     }
                 });
             }

             // Kiểm tra va chạm từ trên xuống (đứng trên platform)
             let highestPlatformY = -Infinity;
             let foundPlatformBelow = false;

             gameElements.forEach(element => {
                 if (isGameOver) return;
                 if (element.classList.contains('platform') || element.classList.contains('obstacle') || element.classList.contains('moving-obstacle')) {
                     const elementRect = getElementRect(element);

                     const horizontalOverlap = (
                         playerX + hitboxXOffset < elementRect.right &&
                         playerX + playerActualWidth - hitboxXOffset > elementRect.left
                     );

                     const playerBottom = playerY + hitboxYOffset;
                     const previousPlayerBottom = previousPlayerY + hitboxYOffset;
                     
                     if (horizontalOverlap &&
                         yVelocity <= 0 && 
                         playerBottom <= elementRect.top + 5 && 
                         previousPlayerBottom >= elementRect.top - 5) { 

                         if (element.classList.contains('hazard')) {
                             endGame('Bạn đã chạm chướng ngại vật nguy hiểm!');
                             if (isGameOver) return;
                         }

                         if (element.classList.contains('moving-obstacle') && elementRect.top > highestPlatformY) {
                            // Nếu đang đứng trên vật thể di chuyển, di chuyển theo nó
                            const movingObs = movingObstacles.find(obs => obs.element === element);
                            if (movingObs) {
                                playerX += movingObs.direction * movingObs.speed;
                            }
                         }

                         if (elementRect.top > highestPlatformY) {
                             highestPlatformY = elementRect.top;
                             foundPlatformBelow = true;
                         }
                     }
                 }
             });

             if (foundPlatformBelow) {
                 newPlayerY = highestPlatformY - hitboxYOffset;
                 yVelocity = 0;
                 isJumping = false;
                 playerCurrentlyOnPlatform = true;
             } else {
                 playerCurrentlyOnPlatform = false;
             }

             playerY = newPlayerY;
             isOnPlatform = playerCurrentlyOnPlatform; 
        }


        // ... (Giữ nguyên các hàm updateMovingObstacles, checkFinishLine, endGame, resetGame, updateLevelDisplay) ...
        function updateMovingObstacles() {
            if (isGameOver) return;
            movingObstacles.forEach(obs => {
                const currentLeft = parseInt(obs.element.style.left);
                
                obs.element.style.left = currentLeft + obs.direction * obs.speed + 'px';
                
                const newLeft = parseInt(obs.element.style.left);
                
                if (obs.direction > 0 && newLeft >= obs.initialLeft + obs.range) {
                    obs.direction = -1;
                } else if (obs.direction < 0 && newLeft <= obs.initialLeft) {
                    obs.direction = 1;
                }
            });
        }

        function checkFinishLine() {
            if (isGameOver) return;
            const finishRect = getElementRect(finishLine);
            const playerHitbox = {
                left: playerX + hitboxXOffset,
                right: playerX + playerActualWidth - hitboxXOffset,
                bottom: playerY + hitboxYOffset,
                top: playerY + playerActualHeight
            };

            const horizontalOverlap = playerHitbox.left < finishRect.right && playerHitbox.right > finishRect.left;
            const verticalOverlap = playerHitbox.top > finishRect.bottom && playerHitbox.bottom < finishRect.top;

            if (horizontalOverlap && verticalOverlap) {
                endGame('Hoàn thành Màn ' + gameLevel + '!', true);
            }
        }

        function endGame(message, isWin = false) {
            if (isGameOver) return;
            isGameOver = true;
            clearInterval(timerInterval);

            gameMessage.innerHTML = '';
            const p = document.createElement('p');
            p.textContent = message;
            gameMessage.appendChild(p);

            const resetButton = document.createElement('button');
            resetButton.id = 'reset-button';
            resetButton.textContent = isWin ? 'Tiếp Tục' : 'Chơi Lại';
            gameMessage.appendChild(resetButton);

            if (isWin) {
                const timeTaken = TIME_LIMIT - (performance.now() - startTime);
                const scoreEntry = { level: gameLevel, time: Math.ceil(timeTaken / 1000) };
                winHistory.push(scoreEntry);
                localStorage.setItem('gameWinHistory', JSON.stringify(winHistory));

                const nextLevel = gameLevel < MAX_LEVEL;
                if (nextLevel) {
                    gameLevel++;
                } else {
                    gameMessage.querySelector('p').textContent = 'Chúc mừng! Bạn đã hoàn thành tất cả các màn!';
                    resetButton.textContent = 'Chơi Lại Từ Đầu';
                }

                resetButton.onclick = () => {
                    if (!nextLevel) {
                        gameLevel = 1; // Reset về màn 1
                        currentCharacter = characterProgression[1];
                    } else {
                        currentCharacter = characterProgression[gameLevel];
                    }
                    localStorage.setItem('gameLevel', gameLevel);
                    localStorage.setItem('currentCharacter', currentCharacter);
                    resetGame();
                };
            } else {
                resetButton.onclick = resetGame;
            }

            gameMessage.style.display = 'block';
        }

        function resetGame() {
            isGameOver = false;
            playerX = 50;
            playerY = 0;
            xVelocity = 0;
            yVelocity = 0;
            isJumping = false;
            isOnPlatform = false;
            cameraX = 0;
            
            player.style.backgroundImage = `url('${currentCharacter}')`;
            updateLevelDisplay();
            createLevel(level1Data); // Tạm thời chỉ dùng level 1
            resetCharacterToStart();
            gameMessage.style.display = 'none';
            resetTimer();
            timerInterval = setInterval(updateTimer, 100);
            requestAnimationFrame(gameLoop);
        }

        function resetCharacterToStart() {
            // Đặt lại nhân vật về vị trí ban đầu của level 1
            playerX = 50;
            playerY = 0;
            xVelocity = 0;
            yVelocity = 0;
            isJumping = false;
            isOnPlatform = false;
            updatePlayerPosition();
            updateCamera(); // Cập nhật camera ngay lập tức
        }
        
        function updateLevelDisplay() {
            levelDisplay.textContent = `Màn: ${gameLevel}`;
        }
        
        // Cần giữ nguyên hàm này để nút trên HTML hoạt động
        function resetCharacter() {
            currentCharacter = 'nhanvat.png';
            gameLevel = 1;
            localStorage.setItem('currentCharacter', currentCharacter);
            localStorage.setItem('gameLevel', gameLevel);
            player.style.backgroundImage = `url('${currentCharacter}')`;
            updateLevelDisplay();
            resetGame();
        }
        // -----------------------------------------------

        // --- CAMERA VÀ GAME LOOP ---
        function updateCamera() {
            const containerWidth = gameContainer.offsetWidth;
            const worldWidth = 2500; 

            // Xác định vị trí camera cần di chuyển (căn giữa player)
            let targetCameraX = playerX - containerWidth / 2 + playerActualWidth / 2;

            // Giới hạn camera ở biên trái (0)
            if (targetCameraX < 0) {
                targetCameraX = 0;
            }

            // Giới hạn camera ở biên phải (World Width - Container Width)
            const maxCameraX = worldWidth - containerWidth;
            if (targetCameraX > maxCameraX) {
                targetCameraX = maxCameraX;
            }

            cameraX = targetCameraX;

            // Di chuyển game-world ngược lại
            gameWorld.style.transform = `translateX(${-cameraX}px)`;
        }

        function gameLoop(currentTime) {
            if (isGameOver) return;

            const deltaTime = currentTime - lastFrameTime;

            // Cập nhật Vật lý/Di chuyển
            
            // 1. Tăng tốc độ
            if (isMovingLeft) {
                xVelocity -= moveAcceleration;
            } else if (isMovingRight) {
                xVelocity += moveAcceleration;
            }

            // 2. Giảm tốc (Ma sát)
            xVelocity *= friction;
            
            // 3. Giới hạn tốc độ
            if (xVelocity > maxSpeed) {
                xVelocity = maxSpeed;
            } else if (xVelocity < -maxSpeed) {
                xVelocity = -maxSpeed;
            }

            // 4. Áp dụng Tốc độ (Ngang) và kiểm tra va chạm X
            const previousPlayerX = playerX;
            playerX += xVelocity;
            checkCollisionsX(); // Sửa playerX nếu va chạm ngang
            
            // 5. Áp dụng Trọng lực và Tốc độ (Dọc)
            const previousPlayerY = playerY;
            yVelocity -= gravity;
            playerY += yVelocity;

            // 6. Kiểm tra va chạm Y
            checkCollisionsY(previousPlayerY); // Sửa playerY và yVelocity nếu va chạm dọc
            
            // 7. Kiểm tra Rơi vực chết
            if (playerY < deathFallThreshold) {
                endGame('Bạn đã rơi xuống vực sâu!');
                return;
            }

            // 8. Cập nhật vị trí UI
            updatePlayerPosition();
            updateMovingObstacles();
            checkFinishLine();

            // 9. Cập nhật Camera
            updateCamera();

            lastFrameTime = currentTime;
            requestAnimationFrame(gameLoop);
        }

        // --- LOGIC ĐIỀU KHIỂN CẢM ỨNG (JOYSTICK VÀ JUMP) ---
        
        let touchIdentifier = null; // Theo dõi ngón tay đang chạm joystick
        const joystickRadius = 70; // Bán kính joystick (140px/2)
        const knobMovementLimit = 30; // Giới hạn di chuyển của knob

        // Kết nối nút Nhảy (Jump Button)
        jumpButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            jump();
            jumpButton.style.backgroundColor = 'rgba(255, 255, 255, 0.12)';
        });
        jumpButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            jumpButton.style.backgroundColor = 'rgba(0, 0, 0, 0.35)';
        });

        // Xử lý Joystick
        function updateJoystickMovement(clientX, clientY) {
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const deltaX = clientX - centerX;
            
            // Căn chỉnh khoảng cách: chỉ quan tâm trục X
            const normalizedDeltaX = Math.min(Math.max(deltaX, -joystickRadius), joystickRadius);
            
            // Cập nhật vị trí knob
            const knobX = (normalizedDeltaX / joystickRadius) * knobMovementLimit;
            joystickKnob.style.transform = `translate(${knobX}px, 0)`;

            // Cập nhật trạng thái di chuyển
            const threshold = 15; // Ngưỡng tối thiểu để kích hoạt di chuyển
            isMovingLeft = normalizedDeltaX < -threshold; 
            isMovingRight = normalizedDeltaX > threshold;
        }

        joystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (touchIdentifier === null) {
                const touch = e.changedTouches[0];
                touchIdentifier = touch.identifier;
                updateJoystickMovement(touch.clientX, touch.clientY);
            }
        });

        joystick.addEventListener('touchmove', (e) => {
            e.preventDefault();
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                if (touch.identifier === touchIdentifier) {
                    updateJoystickMovement(touch.clientX, touch.clientY);
                    break;
                }
            }
        });

        joystick.addEventListener('touchend', (e) => {
            e.preventDefault();
            let touchEnded = false;
            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                if (touch.identifier === touchIdentifier) {
                    touchIdentifier = null;
                    isMovingLeft = false;
                    isMovingRight = false;
                    joystickKnob.style.transform = 'translate(0, 0)'; // Đặt knob về giữa
                    touchEnded = true;
                    break;
                }
            }
            // Nếu có nhiều ngón chạm, có thể cần logic chuyển touch ID
        });
        // -----------------------------------------------

        // --- LOGIC ĐIỀU KHIỂN BÀN PHÍM (PC) ---
        document.addEventListener('keydown', (e) => {
            if (isGameOver) return;
            switch (e.key) {
                case 'a':
                case 'A':
                case 'ArrowLeft':
                    isMovingLeft = true;
                    break;
                case 'd':
                case 'D':
                case 'ArrowRight':
                    isMovingRight = true;
                    break;
                case ' ':
                    e.preventDefault(); // Ngăn cuộn trang khi nhấn Space
                    jump();
                    break;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (isGameOver) return;
            switch (e.key) {
                case 'a':
                case 'A':
                case 'ArrowLeft':
                    isMovingLeft = false;
                    break;
                case 'd':
                case 'D':
                case 'ArrowRight':
                    isMovingRight = false;
                    break;
            }
        });
        // -----------------------------------------------

        // --- KHỞI TẠO GAME VÀ LOGIC KIỂM TRA THIẾT BỊ ---
        
        /**
         * Kiểm tra xem thiết bị có hỗ trợ cảm ứng (có thể là di động/tablet) hay không.
         * Nếu là PC, ẩn controls cảm ứng và chỉ hiển thị hướng dẫn PC.
         */
        function checkTouchDevice() {
            const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
            
            if (!isTouch) {
                // Ẩn Controls cảm ứng trên PC
                controlsWrapper.style.display = 'none';
                controlsDesc.innerHTML = 'Hướng dẫn: **A / D** hoặc **← / →** để di chuyển. **Space** để nhảy.';
                controlsDesc.style.maxWidth = '300px'; 
            } else {
                 // Điều chỉnh mô tả di động
                 controlsDesc.innerHTML = 'Hướng dẫn: Dùng **Joystick** để di chuyển. Chạm nút **NHẢY** để nhảy.';
            }
        }


        function init() {
            // Khôi phục trạng thái game nếu có
            const storedCharacter = localStorage.getItem('currentCharacter');
            const storedLevel = localStorage.getItem('gameLevel');
            if (storedCharacter && storedLevel) {
                currentCharacter = storedCharacter;
                gameLevel = parseInt(storedLevel);
            }
            
            player.style.backgroundImage = `url('${currentCharacter}')`;
            
            checkTouchDevice(); // Áp dụng tối ưu hóa giao diện PC/Mobile

            resetGame(); // Bắt đầu game
        }

        init();
    </script>
</body>
</html>
